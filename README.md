# üêâ Dragon's Treasure Aulify Games ‚Äì Documentaci√≥n API y Frontend

## üåê Descripci√≥n General

**Dragon's Treasure** es un proyecto de videojuego desarrollado con **Unity**. Este repositorio contiene el servicio backend en **Node.js/Express** y un **frontend de administraci√≥n/dashboard** en **React/Vite**.

El sistema ahora se integra con la plataforma **Aulify**, actuando como un **proxy** para la autenticaci√≥n y ciertas operaciones (monedas, stickers), mientras maneja localmente las estad√≠sticas espec√≠ficas del juego (partidas, victorias, niveles, progreso) y preferencias de usuario como el avatar.

> Este proyecto fue desarrollado con fines educativos üìö y de aprendizaje pr√°ctico sobre integraci√≥n backend-frontend, manejo de APIs externas, autenticaci√≥n JWT y persistencia de datos de usuario.

---

## üöÄ Caracter√≠sticas Principales

### üîß API (Backend)

-   **Autenticaci√≥n Proxy:** Utiliza la API de Aulify para el login (`/aulifyLogin`), valida credenciales externamente.
-   **Autenticaci√≥n Propia (JWT):** Genera un token JWT propio (`token`) para proteger las rutas del backend local.
-   **Proxy API Aulify:** Endpoints seguros (`/aulify/*`) que reenv√≠an solicitudes a la API de Aulify (`/getCoins`, `/getLastSticker`).
-   **Gesti√≥n de Estad√≠sticas Locales:**
    -   Seguimiento de historial de partidas individuales (`estadistica`).
    -   Contadores totales de victorias, derrotas y partidas en la tabla `usuario`.
    -   Sistema de niveles y progreso (XP) basado en victorias.
-   **Sincronizaci√≥n de Monedas:** Mantiene la columna `monedas` en la tabla `usuario` sincronizada con Aulify.
-   **Gesti√≥n de Preferencias de Usuario:**
    -   Almacena y recupera el `avatar_sticker_id` preferido por el usuario.
-   **Funcionalidades de Administrador:**
    -   Endpoint para obtener un resumen de estad√≠sticas de la plataforma.
    -   Endpoint para listar todos los usuarios (paginado).
    -   Endpoint para obtener estad√≠sticas detalladas de un usuario espec√≠fico.
-   **Base de Datos:** Utiliza MySQL para almacenar datos de usuario, estad√≠sticas del juego y preferencias.

### üíé Frontend (Dashboard & Admin Dashboard)

-   **Login:** Interact√∫a con el endpoint `/aulifyLogin`, almacena tokens y datos de usuario (incluyendo `avatar_sticker_id`).
-   **Dashboard de Usuario:**
    -   Visualizaci√≥n de datos del perfil (gamertag, nivel, progreso XP).
    -   **Selecci√≥n de Avatar:** Permite al usuario elegir un avatar de perfil entre los stickers desbloqueados, con persistencia en el backend.
    -   Muestra saldo de monedas y √∫ltimo sticker obtenido (desde Aulify v√≠a proxy).
    -   Muestra historial de partidas recientes, leaderboard y gr√°fica de tiempo jugado.
    -   Pesta√±a de "Estad√≠sticas Detalladas" con resumen completo y gr√°ficas.
-   **Admin Dashboard (`/admin`):
    -   Muestra un resumen de estad√≠sticas de la plataforma (total usuarios, partidas, etc.).
    -   Tabla paginada de todos los usuarios registrados.
    -   **Modal de Detalles de Usuario:** Al hacer clic en un usuario, muestra sus estad√≠sticas detalladas (perfil, rendimiento, gr√°ficas, historial) de forma similar al dashboard de usuario.
-   **Sincronizaci√≥n Autom√°tica:** Actualiza datos y sincroniza monedas al recuperar el foco.
-   **Interfaz Moderna:** Estilo *glassmorphism*, modo claro/oscuro, responsiva.

---

## üõ†Ô∏è Instalaci√≥n

### üì¶ Requisitos Previos

-   [Node.js](https://nodejs.org/) (v18+ recomendado)
-   [MySQL](https://www.mysql.com/) (servidor activo)
-   Un cliente de Base de Datos (Dbeaver, MySQL Workbench, etc.)

### üê±‚Äçüíª Clona el repositorio

```bash
git clone https://github.com/mariovital/dragons-treasure.git
cd dragons-treasure
```

### üíæ Base de Datos

1.  Con√©ctate a tu servidor MySQL usando tu cliente de BD.
2.  Crea una nueva base de datos (ej: `dragons_treasure_db`).
3.  Ejecuta el script `DragonsTreasureDB.sql` contenido en este repositorio. **Aseg√∫rate que el script incluya la columna `avatar_sticker_id` (INTEGER, NULLABLE) en la tabla `usuario`.**

### üîô Backend (API)

1.  (Desde la ra√≠z del proyecto `dragons-treasure`) Instala dependencias:

    ```bash
    npm install
    ```

2.  Crea un archivo `.env` en la ra√≠z del proyecto con tus variables de entorno:

    ```dotenv
    # Server Port
    PORT=3000

    # Database Connection
    DB_HOST=localhost
    DB_USER=root
    DB_PASSWORD=tu_contrase√±a_de_mysql
    DB_PORT=3306
    DB_NAME=dragons_treasure_db

    # API Keys & Secrets
    AULIFY_API_KEY=tu_api_key_de_aulify # ¬°Obligatoria para login y proxy!
    BACKEND_JWT_SECRET=un_secreto_muy_largo_y_seguro_para_firmar_tus_tokens # ¬°Obligatorio!

    # Frontend URL (para CORS)
    FRONTEND_URL=http://localhost:5173
    ```

3.  Ejecuta el servidor backend:

    ```bash
    node index.js
    # O si tienes nodemon: npm run dev
    ```

### üñºÔ∏è Frontend (Dashboard)

1.  Abre una **nueva terminal**.
2.  Ve a la carpeta del frontend:

    ```bash
    cd Front/dragons-treasure
    ```

3.  Instala dependencias:

    ```bash
    npm install
    ```

4.  Ejecuta el servidor de desarrollo:

    ```bash
    npm run dev
    ```

5.  Abre tu navegador en la direcci√≥n que indique Vite (usualmente `http://localhost:5173`).

---

## üîå Endpoints Principales de la API (Backend Local)

**Prefijo Base:** `http://localhost:3000` (o la URL de despliegue, ej: `https://ymqnqltlqg.execute-api.us-east-1.amazonaws.com`)

**Autenticaci√≥n:**

-   `POST /aulifyLogin`
    -   **Descripci√≥n:** Autentica al usuario contra Aulify, crea/actualiza el usuario local y devuelve tokens.
    -   **Body:** `{ "email": "user@example.com", "password": "1234" }`
    -   **Headers (Request):** `X-Api-Key: <tu_api_key_de_aulify>`
    -   **Respuesta Exitosa (200 OK):** `{ "success": true, ..., "user": { ..., "avatar_sticker_id": ID_o_null } }`

**Rutas Protegidas (Requieren `Authorization: Bearer <nuestro_jwt>`)**

### Estad√≠sticas (`/estadistica`)

-   `POST /record-game`
    -   **Descripci√≥n:** Registra el resultado de una partida.
    -   **Body:** `{ "outcome": "victory" | "defeat", "durationSeconds": 125 }`
-   `GET /ultimas-partidas`
-   `GET /leaderboard`
-   `GET /tiempo-jugado`
-   `GET /user-summary`

### Proxy Aulify (`/aulify`)

*(Requieren tambi√©n `X-Aulify-Token: <token_de_aulify>` en los headers de la solicitud a nuestro backend)*

-   `GET /coins`
-   `GET /last-sticker`

### Usuario (`/api`)

-   `PUT /usuario/sync-coins`
    -   **Descripci√≥n:** Sincroniza monedas con Aulify. *(Requiere `X-Aulify-Token`)*
-   `PUT /avatar`
    -   **Descripci√≥n:** Actualiza la preferencia de avatar del usuario.
    -   **Body:** `{ "stickerId": ID_DEL_STICKER_O_NULL }`
    -   **Respuesta (200 OK):** `{ "success": true, "message": "Preferencia actualizada", "newStickerId": ID_o_null }`

### Administrador (`/admin`)

*(Requieren que el JWT del usuario tenga rol de 'admin')*

-   `GET /stats/summary`
    -   **Descripci√≥n:** Obtiene un resumen de estad√≠sticas de la plataforma.
-   `GET /users`
    -   **Descripci√≥n:** Lista todos los usuarios (paginado, ej. `/users?page=1&limit=10`).
-   `GET /user-stats/:userId`
    -   **Descripci√≥n:** Obtiene estad√≠sticas detalladas para un usuario espec√≠fico.

### üéÆ Endpoints para Cliente Unity

El cliente de juego desarrollado en Unity interact√∫a principalmente con los siguientes dos endpoints del backend para la autenticaci√≥n y el registro de partidas. A continuaci√≥n, se detalla la configuraci√≥n esperada para cada uno:

#### 1. Autenticaci√≥n del Jugador

*   **Endpoint:** `POST [Prefijo_Base]/aulifyLogin`
    *   Reemplazar `[Prefijo_Base]` con la URL de tu backend (ej. `http://localhost:3000` o la URL de producci√≥n).
*   **Prop√≥sito:**
    1.  Autenticar las credenciales del jugador (`email`, `password`) contra la API de Aulify.
    2.  Si la autenticaci√≥n con Aulify es exitosa, el backend crea o actualiza el registro del usuario en la base de datos local.
    3.  Generar y devolver un token JWT espec√≠fico de Dragon's Treasure (`backendToken`) que Unity deber√° usar para las solicitudes subsecuentes a las rutas protegidas del juego (como registrar partidas).
    4.  Devolver tambi√©n el `aulifyToken` para que el backend pueda hacer llamadas proxy a Aulify si fuera necesario en nombre del usuario (aunque esto es menos com√∫n directamente desde Unity para los endpoints que usa).
*   **Headers Requeridos (desde Unity):**
    *   `X-Api-Key`: `tu_api_key_de_aulify` (La misma API key que usa el backend para comunicarse con Aulify).
    *   `Content-Type`: `application/json`
*   **Body (JSON desde Unity):**
    ```json
    {
      "email": "correo_del_usuario@ejemplo.com",
      "password": "la_contrase√±a_del_usuario"
    }
    ```
*   **Respuesta Exitosa Clave (desde el Backend a Unity):**
    Un objeto JSON que incluye:
    *   `success: true`
    *   `token`: El JWT del backend de Dragon's Treasure (este es el que Unity debe almacenar y usar para `record-game`).
    *   `aulifyToken`: El token de Aulify.
    *   `user`: Un objeto con informaci√≥n del usuario, incluyendo `id`, `gamertag`, `nivel`, `progreso`, `avatar_sticker_id`, etc.

#### 2. Registro de Resultado de Partida

*   **Endpoint:** `POST [Prefijo_Base]/estadistica/record-game`
    *   Reemplazar `[Prefijo_Base]` con la URL de tu backend.
*   **Prop√≥sito:**
    1.  Registrar el resultado (victoria o derrota) y la duraci√≥n de una partida jugada en Unity.
    2.  El backend actualizar√° las estad√≠sticas del jugador (total de victorias/derrotas, partidas jugadas) y su progreso de nivel.
*   **Headers Requeridos (desde Unity):**
    *   `Authorization`: `Bearer <tu_token_jwt_obtenido_del_login>` (El `token` recibido del endpoint `/aulifyLogin`).
    *   `Content-Type`: `application/json`
*   **Body (JSON desde Unity):**
    ```json
    {
      "outcome": "victory", // o "defeat"
      "durationSeconds": 125 // Duraci√≥n de la partida en segundos (n√∫mero entero)
    }
    ```
*   **Respuesta Exitosa Clave (desde el Backend a Unity):**
    Un objeto JSON que incluye:
    *   `success: true`
    *   `message`: "Partida registrada y progreso actualizado."
    *   `levelInfo`: Objeto con `nivel` y `progreso` actualizados del jugador.

#### Diagn√≥stico de Problemas (Troubleshooting) desde Unity

Si los datos de Unity no parecen llegar correctamente a la base de datos, considera los siguientes puntos de revisi√≥n en tu cliente de Unity y en la configuraci√≥n del backend:

1.  **URL del Endpoint en Unity:**
    *   Verifica que Unity est√© apuntando exactamente a la URL correcta del backend desplegado (ej. `https://tu-api.com/aulifyLogin`) o de desarrollo (`http://localhost:3000/aulifyLogin`). Un error com√∫n es una `/` extra o faltante, o un error tipogr√°fico.

2.  **Headers de la Solicitud desde Unity:**
    *   **`POST /aulifyLogin`**:
        *   Aseg√∫rate de que el header `X-Api-Key` se est√© enviando con el valor correcto de tu Aulify API Key.
        *   Aseg√∫rate de que el header `Content-Type` est√© configurado como `application/json`.
    *   **`POST /estadistica/record-game`**:
        *   Aseg√∫rate de que el header `Authorization` se est√© enviando con el formato `Bearer <JWT_TOKEN>`, donde `<JWT_TOKEN>` es el token (`token`) obtenido de la respuesta del login.
        *   Verifica que el token JWT no haya expirado y sea v√°lido.
        *   Aseg√∫rate de que el header `Content-Type` est√© configurado como `application/json`.

3.  **Formato y Contenido del Body JSON (desde Unity):**
    *   Confirma que el cuerpo de la solicitud POST est√© correctamente formateado como JSON.
    *   Verifica que los nombres de los campos (claves) en el JSON coincidan exactamente con lo que espera el backend (ej. `email`, `password`, `outcome`, `durationSeconds`).
    *   Aseg√∫rate de que los tipos de datos sean los correctos (ej. `durationSeconds` debe ser un n√∫mero).

4.  **Manejo de Errores y Logs en Unity:**
    *   Implementa un manejo robusto de errores en el c√≥digo C# de Unity que realiza las llamadas HTTP.
    *   Revisa la consola de Unity para cualquier mensaje de error relacionado con las solicitudes de red (ej. errores de conexi√≥n, timeouts, c√≥digos de estado HTTP como 400, 401, 403, 404, 500).
    *   Loguea la respuesta completa del servidor en la consola de Unity para entender qu√© est√° devolviendo el backend.

5.  **Logs del Servidor Backend:**
    *   Revisa los logs de tu servidor backend (Node.js/Express). Si las solicitudes llegan, los logs deber√≠an mostrar el `req.body` y `req.headers` recibidos. Esto es crucial para ver si la informaci√≥n que env√≠a Unity es la que el backend espera.
    *   Presta atenci√≥n a cualquier error que el backend pueda estar registrando durante el procesamiento de la solicitud. (Revisa la secci√≥n "An√°lisis de los Controladores" en la conversaci√≥n anterior para ver ejemplos de logs √∫tiles).

6.  **Configuraci√≥n de Red/CORS (para backend desplegado):**
    *   Si tu backend est√° desplegado (ej. en AWS Elastic Beanstalk, Vercel, etc.), aseg√∫rate de que la configuraci√≥n de CORS permita solicitudes del "origen" desde donde Unity podr√≠a estar haciendo las llamadas (aunque Unity no es un navegador, algunos gateways/proxies pueden imponer estas reglas).
    *   Verifica que no haya firewalls o configuraciones de red bloqueando las peticiones.

Para una gu√≠a m√°s exhaustiva sobre la implementaci√≥n de estos endpoints en Unity, incluyendo ejemplos de c√≥digo C# y manejo de errores m√°s detallado, puedes consultar el archivo `docs/Unity_Backend_Integration.md` si decides crearlo o expandirlo con esa informaci√≥n.

---

## üèóÔ∏è Arquitectura

El backend se organiza modularmente:

-   üìÅ **routes:** Definici√≥n de endpoints y asociaci√≥n con controladores/middleware.
-   üß† **controllers:** L√≥gica de negocio, interacci√≥n con la base de datos y llamadas a APIs externas.
-   üõ°Ô∏è **middleware:** Autenticaci√≥n (verificaci√≥n de JWT, verificaci√≥n de rol de admin).
-   üîß **helpers:** Configuraci√≥n y gesti√≥n de la conexi√≥n a MySQL.

---

## üîÑ Integraci√≥n

-   üïπÔ∏è **Cliente de juego Unity:** Consume `/aulifyLogin` y `/estadistica/record-game`. (Ver `docs/Unity_Backend_Integration.md`).
-   üîó **API Externa (Aulify):** El backend act√∫a como intermediario.
-   üñºÔ∏è **Frontend (Dashboard React):** Interact√∫a con todos los endpoints relevantes del backend local.

---

## üõ°Ô∏è Seguridad

-   ‚úÖ **Autenticaci√≥n JWT:** Rutas sensibles protegidas.
-   üîí **Tokens Separados:** Manejo diferenciado del token JWT propio y el de Aulify.
-   üîë **Roles de Usuario:** Middleware para restringir acceso a rutas de administrador.
-   üîê **Variables de Entorno:** Gesti√≥n de datos sensibles.
-   üõ°Ô∏è **CORS:** Configuraci√≥n para permitir solicitudes desde or√≠genes especificados.

---

## üìÅ Estructura del Proyecto (Simplificada)

```
/ (Ra√≠z del Proyecto)
‚îÇ‚îÄ‚îÄ controllers/         # auth.controller.js, estadistica.controller.js, usuario.controller.js, admin.controller.js
‚îÇ‚îÄ‚îÄ middleware/          # verifyTokenPresence.js, verifyAdminRole.js
‚îÇ‚îÄ‚îÄ routes/              # auth.routes.js, estadistica.routes.js, usuario.routes.js, aulify.routes.js, admin.routes.js
‚îÇ‚îÄ‚îÄ helpers/             # mysql-config.js
‚îÇ‚îÄ‚îÄ Front/               # C√≥digo fuente del Dashboard React
‚îÇ   ‚îî‚îÄ‚îÄ dragons-treasure/
‚îÇ       ‚îú‚îÄ‚îÄ public/
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ components/
‚îÇ           ‚îú‚îÄ‚îÄ pages/       # Dashboard.jsx, Login.jsx, AdminDashboard.jsx
‚îÇ           ‚îú‚îÄ‚îÄ contexts/
‚îÇ           ‚îú‚îÄ‚îÄ assets/
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îÇ‚îÄ‚îÄ docs/                # Documentaci√≥n (Unity_Backend_Integration.md)
‚îÇ‚îÄ‚îÄ .env                 # Variables de entorno
‚îÇ‚îÄ‚îÄ .gitignore
‚îÇ‚îÄ‚îÄ DragonsTreasureDB.sql # Script SQL (¬°Debe estar actualizado!)
‚îÇ‚îÄ‚îÄ index.js             # Punto de entrada del servidor Backend
‚îÇ‚îÄ‚îÄ package.json
‚îÇ‚îÄ‚îÄ package-lock.json
‚îî‚îÄ‚îÄ README.md            # Este archivo
```

--- 

## üìå Nota

Este proyecto forma parte del desarrollo del juego **Dragon's Treasure** üêâ y fue construido con prop√≥sitos educativos para Aulify.
